Development Plan — Photo Watermark (Python)

目标
本开发计划针对 Windows 桌面应用，使用 Python 技术栈（PyQt/PySide + Pillow/OpenCV 或更现代的图像库），实现一个离线、可批量处理图片的水印工具。MVP 包括：字体选择与 JPEG 质量调整。

目录
- 1. 技术选型与理由
- 2. 项目结构建议
- 3. 详细开发任务（拆解）
- 4. 每项任务的实现要点与验收标准
- 5. 时间估算（人日）与里程碑
- 6. 测试计划
- 7. 打包与发布建议
- 8. 风险与缓解

1. 技术选型与理由
- 框架：PyQt5 / PySide6（推荐 PySide6）：稳定、丰富的桌面 UI 支持，良好 Windows 集成。PySide6 为 LGPL 与官方支持。\
- 图像处理：Pillow（PIL 分支，易用）作为首选；当需要更高性能或更复杂的操作（旋转高质量、Alpha 复合）时，可选择 OpenCV 或结合使用 ImageMagick via Wand。\
- 字体与渲染：利用 Qt 的字体渲染（QFont）与 QPainter 进行高质量文本渲染；对于导出时的精确合成可以用 Pillow（ImageFont）或直接用 Qt 的 QImage 转为 PIL Image。\
- 多线程：使用 Python 的线程池（concurrent.futures.ThreadPoolExecutor）处理并发导出/缩略图生成，UI 与渲染在主线程（Qt 线程约束）。\
- 配置持久化：JSON 存储在用户配置目录（Windows: %APPDATA%\PhotoWatermark\config.json）。\

2. 项目结构建议（示例）
photo_watermark/
  ├── app.py                # 程序入口（Qt 应用初始化）
  ├── README.md
  ├── requirements.txt     # 列出依赖（PySide6, Pillow, opencv-python 可选）
  ├── src/
  │   ├── ui/              # Qt UI 文件或基于代码的 UI
  │   │   ├── main_window.py
  │   │   └── widgets.py
  │   ├── core/            # 核心逻辑（图像合成、导出）
  │   │   ├── image_processor.py
  │   │   └── watermark.py
  │   ├── io/              # 导入/导出、缩略图、文件系统逻辑
  │   │   └── file_manager.py
  │   ├── templates/       # 模板管理（保存/加载 json）
  │   │   └── template_manager.py
  │   └── utils/
  │       └── helpers.py
  └── assets/

3. 详细开发任务（按优先级拆解）
- T0: 环境与依赖准备（0.5d）
  - 安装 Python 发行版（3.10+ 推荐）、创建虚拟环境、安装 PySide6/Pillow、配置 linter（可选）。

- T1: 项目脚手架与空窗口（0.5–1d）
  - 产物：可启动的 Qt 窗口（主窗口框架）、菜单与占位控件（缩略图面板、预览面板、右侧控制面板）。
  - 验收：运行 `python app.py` 后出现主窗口。

- T2: 文件导入与缩略图（1.5–2.5d）
  - 支持：拖拽到缩略图面板、文件选择器（多选）、目录导入（递归）、过滤支持格式。\
  - 缩略图生成：异步生成并缓存（可在项目缓存目录或内存中）。\
  - 验收：导入包含多种文件的目录，界面展示缩略图与文件名，点击项更新主预览。

- T3: 主预览基础与图像加载（1–2d）
  - 支持加载图片（保持 alpha）、预览缩放/适配窗口、选择缩略图后更新。\
  - 验收：PNG 带透明区域在预览中正确显示；预览可缩放适配窗口。

- T4: 文本水印渲染（实时预览）（2–4d）
  - 参数：文本内容、字体、字号、粗体/斜体、颜色选择器、透明度（0–100%）、九宫格锚点。\
  - 渲染路径：优先使用 Qt/QPainter 在预览上实时合成，导出时用 Pillow 或将 QImage 转为 PIL 处理以生成最终文件。\
  - 验收：更改文本/透明度/位置时，预览实时更新且无明显卡顿（常见图片）。

- T5: 拖拽定位与旋转（1.5–3d）
  - 实现预览层上可拖动水印，并保持相对位置（百分比）；提供旋转滑块（数值/拖动）。\
  - 验收：拖拽或输入角度能改变水印位置与旋转，且导出保持一致。

- T6: 导出基础功能（2–3d）
  - 导出到指定目录（默认禁止源目录），命名规则（保留/前缀/后缀）、PNG/JPEG 输出、JPEG 质量滑块（0–100），确保文件名安全。\
  - 验收：导出文件存在且水印正确叠加；JPEG 质量影响文件大小与视觉质量。

- T7: 模板保存与自动加载（1–1.5d）
  - 保存 WatermarkConfig 到 JSON；列表管理模板（载入/删除）；启动时加载最后设置。\
  - 验收：保存模板并能恢复全部设置；重启后自动载入最后设置。

- T8: 图片水印（可选，高级）（2–4d）
  - 支持选择本地图片（PNG alpha）、缩放、透明度、旋转。\
  - 验收：PNG logo 的透明区域正确保留；缩放与透明度生效。

- T9: 批量导出与并发（2–3d）
  - 使用线程池异步导出，显示全局进度、单文件状态、取消与错误报告策略。\
  - 验收：批量导出按队列执行；遇错误记录并继续其他任务。

- T10: 错误处理、性能与大图策略（1–2d）
  - 预览降采样策略、导出时处理原始分辨率、处理内存峰值与异常。\
  - 验收：大图预览不导致 UI 无响应；导出成功或合理失败报告。

- T11: 测试、打包、文档（2–4d）
  - 单元测试核心处理逻辑、基本集成测试（导入->设置->导出）、使用 PyInstaller 打包成 Windows 可执行（或使用 brief installer）。\
  - 验收：核心测试通过；能在干净 Windows 环境下运行生成的 EXE。

4. 每项任务的实现要点与验收标准（细化）
- 缩略图生成
  - 使用 Pillow 打开并缩放到合理大小（如 256x256），并缓存缩略图路径或内存中的 QPixmap。\
  - 验收：UI 列表显示缩略图且性能平稳。

- 实时渲染
  - 使用 QPainter 在 QPixmap/QImage 上绘制文本水印；绘制时应用透明度与阴影/描边（如启用）。\
  - 验收：参数更改时主预览快速更新，无明显闪烁。

- 导出合成
  - 导出使用 Pillow 完成最终合成，以确保文件格式与质量设置可控。若使用 QImage -> bytes 转换也可行。\
  - 验收：输出文件在不同查看器中显示正确且保留透明（PNG）。

- 模板
  - 规范 JSON 字段（参照 watermark_app.pcd 中的 WatermarkConfig），包含版本号以便向后兼容。\
  - 验收：模板 JSON 可移植导入导出，且不同机器间可用。

5. 时间估算（汇总）
- 环境与脚手架：1d
- 核心功能（导入/预览/文本水印/导出/模板）：9–14d
- 高级（图片水印、并发导出、优化）：5–9d
- 测试 & 打包 & 文档：2–4d
- 总计（MVP + 部分高级）：约 17–28 人日（单人开发，不含设计美化）

6. 测试计划
- 单元测试：image_processor（合成/opacity/rotate/scale）、file_manager（命名规则、路径问题）、template_manager（序列化/反序列化）。\
- 集成测试：脚本化流程导入样例图片、应用水印、导出并比较输出像素（或使用视觉差异阈值）。\
- 手工测试：UI 交互、拖拽、模板保存/加载、多格式导入。

7. 打包与发布建议
- 使用 PyInstaller 生成单文件 EXE（注意需要测试是否包含所有 Qt 插件与字体）。\
- 可选生成安装器：Inno Setup（小巧），或 MSIX（更现代的 Windows 打包）。\
- 发布注意：对外提供 SHA256 校验、版本说明、最小运行时依赖说明（Python 内嵌或捆绑）。

8. 风险与缓解
- 性能与内存：大图可能导致内存峰值——采取预览降采样、流式导出与批次限制。\
- 字体渲染差异：Qt 渲染为主，导出以 Pillow 保证一致性（或采用 QImage->PIL 转换）。\
- 打包兼容问题：在目标 Windows 环境多次测试打包产物，使用自动化脚本复现打包流程。

Change log:
- v0.1 initial plan (Python, MVP includes font and JPEG quality)
